
// MANUTENÇÃO FUTURA DO CÓDIGO (PARA DESENVOLVEDORES/GESTORES):
// ------------------------------------------------------------
// Esta lista contém os valores oficiais do VNA (Valor Nominal Atualizado) divulgados pelo Tesouro Nacional.
// Para manter a precisão do sistema no futuro (ex: em 2026, 2027...):
// 1. Acesse o site do Tesouro Direto ou Anbima.
// 2. Copie os novos valores de VNA publicados para os dias 15 de cada mês.
// 3. Adicione as novas linhas abaixo no objeto OFFICIAL_VNA_HISTORY seguindo o formato 'AAAA-MM-DD': valor.
// 
// Se a data solicitada pelo usuário for posterior à última data desta lista, o sistema
// fará uma projeção automática baseada no IPCA inserido no formulário.
// O usuário também pode corrigir manualmente o valor no formulário se esta lista estiver desatualizada.

// Official Data Source: Derived from user-provided STN/Anbima Table (2000-2025)
// VNA methodology: Base 15/07/2000 = 1000.00.
// This table acts as the source of truth.

const OFFICIAL_VNA_HISTORY: Record<string, number> = {
  // 2000
  '2000-07-15': 1000.000000,
  '2000-08-15': 1016.102860,
  '2000-09-15': 1029.412493,
  '2000-10-15': 1031.778375,
  '2000-11-15': 1033.221439,
  '2000-12-15': 1036.528718,
  // 2001
  '2001-01-15': 1042.641612,
  '2001-02-15': 1048.587283,
  '2001-03-15': 1053.411948,
  '2001-04-15': 1057.412889,
  '2001-05-15': 1063.544363,
  '2001-06-15': 1067.904522,
  '2001-07-15': 1073.460009,
  '2001-08-15': 1087.735813,
  '2001-09-15': 1095.347512,
  '2001-10-15': 1098.413248,
  '2001-11-15': 1107.529945,
  '2001-12-15': 1115.395572,
  // 2002
  '2002-01-15': 1122.648053,
  '2002-02-15': 1128.488436,
  '2002-03-15': 1132.551312,
  '2002-04-15': 1139.345480,
  '2002-05-15': 1148.462176,
  '2002-06-15': 1150.871412,
  '2002-07-15': 1155.702270,
  '2002-08-15': 1169.457829,
  '2002-09-15': 1177.057140,
  '2002-10-15': 1185.529722,
  '2002-11-15': 1201.062788,
  '2002-12-15': 1237.337577,
  // 2003
  '2003-01-15': 1263.318923,
  '2003-02-15': 1291.746664,
  '2003-03-15': 1312.030075,
  '2003-04-15': 1328.170095,
  '2003-05-15': 1341.052383,
  '2003-06-15': 1349.233875,
  '2003-07-15': 1347.208631,
  '2003-08-15': 1349.902763,
  '2003-09-15': 1354.492078,
  '2003-10-15': 1365.058032,
  '2003-11-15': 1369.015619,
  '2003-12-15': 1373.673062,
  // 2004
  '2004-01-15': 1380.814061,
  '2004-02-15': 1391.305694,
  '2004-03-15': 1399.790662,
  '2004-04-15': 1406.368061,
  '2004-05-15': 1411.570524,
  '2004-06-15': 1418.767264,
  '2004-07-15': 1428.837745,
  '2004-08-15': 1441.837707,
  '2004-09-15': 1451.784320,
  '2004-10-15': 1456.578018,
  '2004-11-15': 1462.988195,
  '2004-12-15': 1473.083449,
  // 2005
  '2005-01-15': 1485.748968,
  '2005-02-15': 1494.363998,
  '2005-03-15': 1503.183411,
  '2005-04-15': 1512.349655,
  '2005-05-15': 1525.504453,
  '2005-06-15': 1532.979896,
  '2005-07-15': 1532.670225,
  '2005-08-15': 1536.503945,
  '2005-09-15': 1539.117563,
  '2005-10-15': 1544.505827,
  '2005-11-15': 1556.087500,
  '2005-12-15': 1564.646789,
  // 2006
  '2006-01-15': 1570.276597,
  '2006-02-15': 1579.541935,
  '2006-03-15': 1586.020240,
  '2006-04-15': 1592.839181,
  '2006-05-15': 1596.183622,
  '2006-06-15': 1597.781521,
  '2006-07-15': 1594.424694,
  '2006-08-15': 1597.453270,
  '2006-09-15': 1598.252220,
  '2006-10-15': 1601.609047,
  '2006-11-15': 1606.892024,
  '2006-12-15': 1611.871523,
  // 2007
  '2007-01-15': 1619.607090,
  '2007-02-15': 1626.735702,
  '2007-03-15': 1633.895281,
  '2007-04-15': 1639.940047,
  '2007-05-15': 1644.040083,
  '2007-06-15': 1648.641785,
  '2007-07-15': 1653.255874,
  '2007-08-15': 1657.225848,
  '2007-09-15': 1665.017155,
  '2007-10-15': 1668.014765,
  '2007-11-15': 1673.019038,
  '2007-12-15': 1679.373474,
  // 2008
  '2008-01-15': 1691.803644,
  '2008-02-15': 1700.938920,
  '2008-03-15': 1709.275247,
  '2008-04-15': 1717.481512,
  '2008-05-15': 1726.926459,
  '2008-06-15': 1740.570536,
  '2008-07-15': 1753.452824,
  '2008-08-15': 1762.742936,
  '2008-09-15': 1767.679082,
  '2008-10-15': 1772.274590,
  '2008-11-15': 1780.251700,
  '2008-12-15': 1786.661877,
  // 2009
  '2009-01-15': 1791.666150,
  '2009-02-15': 1800.262600,
  '2009-03-15': 1810.165859,
  '2009-04-15': 1813.782809,
  '2009-05-15': 1822.490740,
  '2009-06-15': 1831.056223,
  '2009-07-15': 1837.646009,
  '2009-08-15': 1842.055715,
  '2009-09-15': 1844.817975,
  '2009-10-15': 1849.246262,
  '2009-11-15': 1854.423951,
  '2009-12-15': 1862.029455,
  // 2010
  '2010-01-15': 1868.916525,
  '2010-02-15': 1882.932206,
  '2010-03-15': 1897.616776,
  '2010-04-15': 1907.482875,
  '2010-05-15': 1918.358499,
  '2010-06-15': 1926.608118,
  '2010-07-15': 1926.608118,
  '2010-08-15': 1926.800113,
  '2010-09-15': 1927.568096,
  '2010-10-15': 1936.238867,
  '2010-11-15': 1950.762408,
  '2010-12-15': 1966.951976,
  // 2011
  '2011-01-15': 1979.344985,
  '2011-02-15': 1995.776095,
  '2011-03-15': 2011.742701,
  '2011-04-15': 2027.634985,
  '2011-05-15': 2043.248566,
  '2011-06-15': 2052.854541,
  '2011-07-15': 2055.932665,
  '2011-08-15': 2059.221364,
  '2011-09-15': 2066.839256,
  '2011-10-15': 2077.795394,
  '2011-11-15': 2086.732481,
  '2011-12-15': 2097.583332,
  // 2012
  '2012-01-15': 2108.068771,
  '2012-02-15': 2119.873406,
  '2012-03-15': 2129.411254,
  '2012-04-15': 2133.882895,
  '2012-05-15': 2147.539359,
  '2012-06-15': 2155.268731,
  '2012-07-15': 2156.990499,
  '2012-08-15': 2166.268224,
  '2012-09-15': 2175.149570,
  '2012-10-15': 2187.548773,
  '2012-11-15': 2200.455834,
  '2012-12-15': 2213.660180,
  // 2013
  '2013-01-15': 2231.150363,
  '2013-02-15': 2250.337540,
  '2013-03-15': 2263.839169,
  '2013-04-15': 2274.479444,
  '2013-05-15': 2286.990127,
  '2013-06-15': 2295.450322,
  '2013-07-15': 2301.420767,
  '2013-08-15': 2302.108235,
  '2013-09-15': 2307.632755,
  '2013-10-15': 2315.708959,
  '2013-11-15': 2328.907111,
  '2013-12-15': 2341.485922,
  // 2014
  '2014-01-15': 2363.026594,
  '2014-02-15': 2376.026557,
  '2014-03-15': 2392.414314,
  '2014-04-15': 2414.425685,
  '2014-05-15': 2430.602866,
  '2014-06-15': 2441.781967,
  '2014-07-15': 2451.548971,
  '2014-08-15': 2451.796707,
  '2014-09-15': 2457.928181,
  '2014-10-15': 2471.937669,
  '2014-11-15': 2482.317820,
  '2014-12-15': 2494.977146,
  // 2015
  '2015-01-15': 2514.436833,
  '2015-02-15': 2545.614447,
  '2015-03-15': 2576.668194,
  '2015-04-15': 2610.682389,
  '2015-05-15': 2629.219259,
  '2015-06-15': 2648.672752,
  '2015-07-15': 2669.600277,
  '2015-08-15': 2686.149062,
  '2015-09-15': 2692.057573,
  '2015-10-15': 2706.593501,
  '2015-11-15': 2728.784481,
  '2015-12-15': 2756.345146,
  // 2016
  '2016-01-15': 2782.803384,
  '2016-02-15': 2818.142968,
  '2016-03-15': 2843.504973,
  '2016-04-15': 2855.730760,
  '2016-05-15': 2873.152816,
  '2016-06-15': 2895.560565,
  '2016-07-15': 2905.692980,
  '2016-08-15': 2920.804895,
  '2016-09-15': 2933.656216,
  '2016-10-15': 2936.003517,
  '2016-11-15': 2943.639989,
  '2016-12-15': 2948.941546,
  // 2017
  '2017-01-15': 2957.785732,
  '2017-02-15': 2969.026767,
  '2017-03-15': 2978.824738,
  '2017-04-15': 2986.269215,
  '2017-05-15': 2990.449765,
  '2017-06-15': 2999.721296,
  '2017-07-15': 2992.821840,
  '2017-08-15': 3000.006193,
  '2017-09-15': 3005.704128,
  '2017-10-15': 3010.510212,
  '2017-11-15': 3023.157151,
  '2017-12-15': 3031.623539,
  // 2018
  '2018-01-15': 3044.964140,
  '2018-02-15': 3053.795939,
  '2018-03-15': 3063.569137,
  '2018-04-15': 3066.325203,
  '2018-05-15': 3073.069824,
  '2018-06-15': 3085.363738,
  '2018-07-15': 3124.239759,
  '2018-08-15': 3134.551783,
  '2018-09-15': 3131.733782,
  '2018-10-15': 3146.765183,
  '2018-11-15': 3160.923313,
  '2018-12-15': 3154.283980,
  // 2019
  '2019-01-15': 3159.015743,
  '2019-02-15': 3169.123385,
  '2019-03-15': 3182.748882,
  '2019-04-15': 3206.618275,
  '2019-05-15': 3224.895021,
  '2019-06-15': 3229.087958,
  '2019-07-15': 3229.410015,
  '2019-08-15': 3235.547683,
  '2019-09-15': 3239.108892,
  '2019-10-15': 3237.814470,
  '2019-11-15': 3241.053622,
  '2019-12-15': 3257.583827,
  // 2020
  '2020-01-15': 3295.047751,
  '2020-02-15': 3301.965787,
  '2020-03-15': 3310.221600,
  '2020-04-15': 3312.537934,
  '2020-05-15': 3302.269264,
  '2020-06-15': 3289.721420,
  '2020-07-15': 3298.274516,
  '2020-08-15': 3310.147279,
  '2020-09-15': 3318.093421,
  '2020-10-15': 3339.330616,
  '2020-11-15': 3368.049448,
  '2020-12-15': 3398.025541,
  // 2021
  '2021-01-15': 3443.900112,
  '2021-02-15': 3452.508949,
  '2021-03-15': 3482.200146,
  '2021-04-15': 3514.585475,
  '2021-05-15': 3525.479679,
  '2021-06-15': 3554.743530,
  '2021-07-15': 3573.583877,
  '2021-08-15': 3607.889162,
  '2021-09-15': 3639.277353,
  '2021-10-15': 3681.491620,
  '2021-11-15': 3727.508639,
  '2021-12-15': 3762.922545,
  // 2022
  '2022-01-15': 3790.390308,
  '2022-02-15': 3810.859521,
  '2022-03-15': 3849.351550,
  '2022-04-15': 3911.712972,
  '2022-05-15': 3953.177837,
  '2022-06-15': 3971.758060,
  '2022-07-15': 3998.371133,
  '2022-08-15': 3971.182073,
  '2022-09-15': 3956.887688,
  '2022-10-15': 3945.411304,
  '2022-11-15': 3968.692323,
  '2022-12-15': 3984.962406,
  // 2023
  '2023-01-15': 4009.667909,
  '2023-02-15': 4030.917491,
  '2023-03-15': 4064.776851,
  '2023-04-15': 4093.638131,
  '2023-05-15': 4118.609951,
  '2023-06-15': 4128.079671,
  '2023-07-15': 4124.778585,
  '2023-08-15': 4129.727118,
  '2023-09-15': 4139.227805,
  '2023-10-15': 4149.991948,
  '2023-11-15': 4159.950948,
  '2023-12-15': 4171.600748,
  // 2024
  '2024-01-15': 4194.962282,
  '2024-02-15': 4212.582527,
  '2024-03-15': 4247.544313,
  '2024-04-15': 4254.338482,
  '2024-05-15': 4270.503276,
  '2024-06-15': 4290.148765,
  '2024-07-15': 4299.160173,
  '2024-08-15': 4315.498383,
  '2024-09-15': 4314.637499,
  '2024-10-15': 4333.620294,
  '2024-11-15': 4357.886066,
  '2024-12-15': 4374.880776,
  // 2025 (Projected/Given)
  '2025-01-15': 4397.629163,
  '2025-02-15': 4404.664874,
  '2025-03-15': 4462.368854,
  '2025-04-15': 4487.359254,
  '2025-05-15': 4506.657913,
  '2025-06-15': 4518.375840,
  '2025-07-15': 4529.220497,
  '2025-08-15': 4540.994165,
  '2025-09-15': 4535.996085,
  '2025-10-15': 4557.765913,
  '2025-11-15': 4561.865949,
};

// Helper: Truncate to 6 decimal places (Rule from NTN-B regulation)
function truncate6(value: number): number {
  if (!isFinite(value)) return 0;
  const factor = 1000000;
  return Math.trunc(value * factor) / factor;
}

// Convert YYYY-MM-DD to Date in UTC
function parseDateUTC(dateStr: string): Date {
  const [y, m, d] = dateStr.split('-').map(Number);
  return new Date(Date.UTC(y, m - 1, d));
}

// Convert Date to YYYY-MM-DD
function formatDateISO(date: Date): string {
  return date.toISOString().split('T')[0];
}

/**
 * Calculates (or Looks up) the VNA for the Reference Date.
 * 
 * Logic:
 * If Purchase Day < 15: Reference is 15th of Previous Month.
 * If Purchase Day >= 15: Reference is 15th of CURRENT Month.
 */
export function getCalculatedVna(targetDateStr: string, monthlyProjectedIpca: number = 0.50): number {
  if (!targetDateStr) return 0;
  
  const targetDate = parseDateUTC(targetDateStr);
  const day = targetDate.getUTCDate();
  
  // Reference Date logic
  const referenceDate = new Date(targetDate);
  referenceDate.setUTCDate(15);
  
  if (day < 15) {
      referenceDate.setUTCMonth(referenceDate.getUTCMonth() - 1);
  }
  
  const refKey = formatDateISO(referenceDate);

  // 1. Direct Lookup
  if (OFFICIAL_VNA_HISTORY[refKey] !== undefined) {
    return OFFICIAL_VNA_HISTORY[refKey];
  }

  // 2. Projection if date is in the future relative to our table
  const allDates = Object.keys(OFFICIAL_VNA_HISTORY).sort();
  const lastKey = allDates[allDates.length - 1];
  const lastDate = parseDateUTC(lastKey);
  let lastVna = OFFICIAL_VNA_HISTORY[lastKey];

  if (referenceDate <= lastDate) {
    return 1000.000000;
  }

  // Project month by month from Last Known Date to Reference Date
  let cursor = new Date(lastDate);
  
  while (cursor < referenceDate) {
    // Apply monthly projection
    const factor = 1 + (monthlyProjectedIpca / 100);
    lastVna = truncate6(lastVna * factor);
    
    // Move to next month
    cursor.setUTCMonth(cursor.getUTCMonth() + 1);
  }

  return lastVna;
}

// Legacy adapter
export function getVnaForDate(dateString: string): number {
    return getCalculatedVna(dateString, 0.50);
}
